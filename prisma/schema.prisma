generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRISMA_DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String?
  role      String   @default("CUSTOMER") // ADMIN, CUSTOMER
  createdAt DateTime @default(now())
  orders    Order[]
  doctor    Doctor?
  prescriptions Prescription[]
  lab       Lab?
  labBookings LabBooking[]
  retailer  Retailer?
  stockist  Stockist?
  deliveryAgent DeliveryAgent?
  appointments Appointment[]
  ambulance    Ambulance?
  ambulanceBookings AmbulanceBooking[]
  medicalRep   MedicalRep?
  pharmaCompany PharmaCompany?
  medicineRequests MedicineRequest[]
  subscriptions Subscription[]
  referralCode   String? @unique
  referredBy     String?
  walletBalance  Float @default(0.0)
  transactions   WalletTransaction[]
  withdrawals    Withdrawal[]
  fcmTokens      String[] @default([]) // Used for Push Notifications
}

model Product {
  id          String   @id @default(cuid())
  name        String
  description String
  price       Float
  image       String
  category    String
  requiresPrescription Boolean @default(false)
  stock       Int      @default(100)
  expiryDate  DateTime?
  batchNumber String?
  createdAt   DateTime @default(now())
  orderItems  OrderItem[]
  stockLogs   StockLog[]
}

model Order {
  id            String      @id @default(cuid())
  userId        String?
  user          User?       @relation(fields: [userId], references: [id])
  guestName     String?
  guestEmail    String?
  guestPhone    String?
  address       String?
  lat           Float?
  lng           Float?
  assignedRetailerId String?
  assignedRetailer Retailer? @relation("AssignedOrders", fields: [assignedRetailerId], references: [id])
  declinedRetailers String[] @default([]) // Array of Retailer IDs who rejected/timed out
  deliveryAgentId String?
  deliveryAgent DeliveryAgent? @relation("AssignedDeliveries", fields: [deliveryAgentId], references: [id])
  assignedAt    DateTime?
  total         Float
  status        String      @default("Processing")
  paymentMethod String      @default("ONLINE") // "ONLINE" or "COD"
  deliveryCode  String?     // Secret code for COD verification
  isPaid        Boolean     @default(false)
  isDelivered   Boolean     @default(false)
  items         OrderItem[]
  prescription  Prescription?
  deliveryProofUrl String?
  createdAt     DateTime    @default(now())
}

model OrderItem {
  id        String  @id @default(cuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id])
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float
}

model StockLog {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  quantity    Int
  buyingPrice Float
  type        String   @default("RESTOCK")
  createdAt   DateTime @default(now())
}

model SMSLog {
  id        String   @id @default(cuid())
  phone     String
  message   String
  status    String   // "Sent", "Failed", "Mock"
  response  String?  // JSON string of API response
  createdAt DateTime @default(now())
}

model Doctor {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  specialization String
  hospital       String?
  experience     Int?
  verified       Boolean  @default(false)
  phone          String?
  consultationFee Float   @default(500.0)
  razorpayAccountId String?
  createdAt      DateTime @default(now())
  prescriptions  Prescription[]
  appointments   Appointment[]
  visits         Visit[]
}

model Prescription {
  id        String   @id @default(cuid())
  imageUrl  String
  patientId String
  patient   User     @relation(fields: [patientId], references: [id])
  doctorId  String?
  doctor    Doctor?  @relation(fields: [doctorId], references: [id])
  medicines String?  // JSON string or text details
  status    String   @default("Pending") // Pending, Processed, Rejected
  orderId   String?  @unique
  order     Order?   @relation(fields: [orderId], references: [id])
  createdAt DateTime @default(now())
}

model Appointment {
  id        String   @id @default(cuid())
  patientId String
  patient   User     @relation(fields: [patientId], references: [id])
  doctorId  String
  doctor    Doctor   @relation(fields: [doctorId], references: [id])
  date      DateTime
  reason    String?
  status    String   @default("Pending") // Pending, Confirmed, Cancelled
  createdAt DateTime @default(now())
}

model Lab {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  name           String
  address        String
  licenseNumber  String
  phone          String
  verified       Boolean  @default(false)
  createdAt      DateTime @default(now())
  tests          LabTest[]
}

model LabTest {
  id             String   @id @default(cuid())
  labId          String
  lab            Lab      @relation(fields: [labId], references: [id])
  name           String
  description    String?
  price          Float
  turnaroundTime String?  // e.g. "24 hours"
  createdAt      DateTime @default(now())
  bookings       LabBooking[]
}

model LabBooking {
  id             String   @id @default(cuid())
  patientId      String
  patient        User     @relation(fields: [patientId], references: [id])
  testId         String
  test           LabTest  @relation(fields: [testId], references: [id])
  status         String   @default("Pending") // Pending, Confirmed, Completed, Cancelled
  bookingDate    DateTime @default(now())
  report         LabReport?
}

model LabReport {
  id             String   @id @default(cuid())
  bookingId      String   @unique
  booking        LabBooking @relation(fields: [bookingId], references: [id])
  reportUrl      String
  uploadedAt     DateTime @default(now())
}

model Retailer {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  shopName       String
  address        String
  licenseNumber  String
  phone          String
  verified       Boolean  @default(false)
  lat            Float?
  lng            Float?
  isOnline       Boolean  @default(false)
  createdAt      DateTime @default(now())
  bulkOrders     BulkOrder[]
  inventory      RetailerInventory[]
  assignedOrders Order[]  @relation("AssignedOrders")
}

model Stockist {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  agencyName     String
  warehouseAddress String
  gstNumber      String
  phone          String
  verified       Boolean  @default(false)
  createdAt      DateTime @default(now())
  receivedOrders BulkOrder[]
}

model BulkOrder {
  id             String   @id @default(cuid())
  retailerId     String
  retailer       Retailer @relation(fields: [retailerId], references: [id])
  stockistId     String?
  stockist       Stockist? @relation(fields: [stockistId], references: [id])
  items          String   // JSON string of items
  status         String   @default("Pending") // Pending, Accepted, Shipped, Delivered
  totalAmount    Float
  createdAt      DateTime @default(now())
}

model Ambulance {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  driverName     String
  vehicleNumber  String
  vehicleType    String   // "Basic", "ICU", "Advance"
  city           String
  isAvailable    Boolean  @default(true)
  phone          String
  currentLat     Float?
  currentLng     Float?
  pricePerKm     Float    @default(20.0)
  createdAt      DateTime @default(now())
  bookings       AmbulanceBooking[]
}

model AmbulanceBooking {
  id             String   @id @default(cuid())
  ambulanceId    String
  ambulance      Ambulance @relation(fields: [ambulanceId], references: [id])
  userId         String?
  user           User?     @relation(fields: [userId], references: [id])
  guestName      String?
  guestPhone     String?
  pickupAddress  String
  dropAddress    String
  distanceKm     Float?
  totalPrice     Float?
  status         String    @default("Pending") // Pending, Accepted, Completed, Cancelled
  createdAt      DateTime  @default(now())
}

model MedicalRep {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  name           String
  company        String
  region         String
  phone          String
  status         String   @default("Pending") // Pending, Active
  verified       Boolean  @default(false)
  createdAt      DateTime @default(now())
  visits         Visit[]
}

model PharmaCompany {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  companyName    String
  licenseNumber  String
  address        String
  phone          String
  createdAt      DateTime @default(now())
  verified       Boolean  @default(false)
  ads            AdCampaign[]
}

model Visit {
  id          String   @id @default(cuid())
  mrId        String
  mr          MedicalRep @relation(fields: [mrId], references: [id])
  doctorId    String
  doctor      Doctor     @relation(fields: [doctorId], references: [id])
  date        DateTime
  notes       String?
  status      String   @default("Scheduled") // Scheduled, Completed
  createdAt   DateTime @default(now())
}

model AdCampaign {
  id             String   @id @default(cuid())
  companyId      String?
  pharmaCompany  PharmaCompany? @relation(fields: [companyId], references: [id])
  title          String
  imageUrl       String
  targetUrl      String?
  position       String   // "Home-Banner", "Sidebar"
  startDate      DateTime
  endDate        DateTime
  status         String   @default("Pending") // Pending, Active, Expired, Rejected
  price          Float
  createdAt      DateTime @default(now())
}

model MedicineRequest {
  id        String   @id @default(cuid())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id])
  guestName String?
  guestPhone String?
  medicineName String
  quantity  String
  prescriptionUrl String?
  status    String   @default("Pending") // Pending, Fulfilled, Cancelled
  createdAt DateTime @default(now())
}

model Subscription {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  medicineName String
  quantity  Int
  frequency String   @default("Monthly") // Monthly, Weekly
  nextDate  DateTime
  status    String   @default("Active") // Active, Paused, Cancelled
  createdAt DateTime @default(now())
}

model RetailerInventory {
  id           String   @id @default(cuid())
  retailerId   String
  retailer     Retailer @relation(fields: [retailerId], references: [id])
  medicineName String
  stock        Int
  price        Float
  deliveryArea String   // e.g., "Sector 62, Noida"
  updatedAt    DateTime @updatedAt
  createdAt    DateTime @default(now())
}

model DeliveryAgent {
  id             String   @id @default(cuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])
  licenseNumber  String
  vehicleNumber  String
  phone          String
  verified       Boolean  @default(false)
  lat            Float?
  lng            Float?
  isOnline       Boolean  @default(false)
  walletBalance  Float    @default(0.0)
  createdAt      DateTime @default(now())
  deliveries     Order[]  @relation("AssignedDeliveries")
}

model WalletTransaction {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  amount      Float
  type        String   // "CREDIT" or "DEBIT"
  description String   // e.g., "Level 1 Referral Bonus", "Delivery Payout", "Withdrawal"
  createdAt   DateTime @default(now())
}

model Withdrawal {
  id            String   @id @default(cuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  amount        Float
  status        String   @default("Pending") // Pending, Completed, Rejected
  paymentMethod String   // e.g., "UPI", "Bank Transfer"
  paymentDetails String  // JSON or string of account info
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
